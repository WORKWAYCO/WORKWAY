/**
 * Pull Request Creation Step
 *
 * Creates GitHub PR with diagnosis and fix details.
 */

import type { Diagnosis } from './diagnose';
import type { Fix } from './fix';

export interface PRInput {
  diagnosis: Diagnosis;
  fix: Fix;
  error: {
    message: string;
    fingerprint: string;
    repo: string;
  };
}

export interface PullRequest {
  url: string;
  number: number;
}

export async function createPR(
  input: PRInput,
  githubToken: string
): Promise<PullRequest> {
  const { diagnosis, fix, error } = input;

  // Prepare PR body
  const body = `
## Error Repair

**Error Fingerprint:** \`${error.fingerprint}\`

### Diagnosis

**Root Cause:** ${diagnosis.root_cause}

**Confidence:** ${diagnosis.confidence}

**Risk Assessment:** ${diagnosis.risk_assessment}

**Affected Files:**
${diagnosis.affected_files.map((f) => `- ${f}`).join('\n')}

### Fix

${fix.changes_summary}

**Files Changed:**
${fix.commits[0].files_changed.map((f) => `- ${f}`).join('\n')}

### Test Results

- ‚úÖ Passed: ${fix.test_results.passed}
- ‚ùå Failed: ${fix.test_results.failed}
- ‚è≠Ô∏è Skipped: ${fix.test_results.skipped}
- ‚è±Ô∏è Duration: ${fix.test_results.duration_ms}ms

### Suggested Approach

${diagnosis.suggested_approach}

---

ü§ñ Generated by WORKWAY Error Repair Agent

**Review Checklist:**
- [ ] Root cause analysis is accurate
- [ ] Fix addresses the root cause (not just symptoms)
- [ ] Tests cover the error case
- [ ] No unintended side effects
- [ ] Risk assessment is acceptable
`;

  // Create PR via GitHub API
  const [owner, repo] = parseRepo(error.repo);

  const response = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/pulls`,
    {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${githubToken}`,
        Accept: 'application/vnd.github.v3+json',
      },
      body: JSON.stringify({
        title: `fix: ${diagnosis.root_cause.slice(0, 72)}`,
        body,
        head: fix.branch,
        base: 'main',
        labels: ['repair-agent', `risk:${diagnosis.risk_assessment}`],
      }),
    }
  );

  if (!response.ok) {
    throw new Error(`GitHub API error: ${response.status} ${await response.text()}`);
  }

  const pr = await response.json();

  return {
    url: pr.html_url,
    number: pr.number,
  };
}

function parseRepo(repo: string): [string, string] {
  // Map repo name to GitHub owner/repo
  const mapping: Record<string, [string, string]> = {
    'workway-platform': ['WORKWAYCO', 'workway-platform'],
    Cloudflare: ['WORKWAYCO', 'Cloudflare'],
  };

  return mapping[repo] || ['WORKWAYCO', repo];
}
