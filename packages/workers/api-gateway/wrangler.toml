# WORKWAY API Gateway
#
# Public API for triggering WORKWAY workflows from external consumers.
# Deployed to: api.workway.co

name = "workway-api-gateway"
main = "src/index.ts"
compatibility_date = "2024-01-01"
compatibility_flags = ["nodejs_compat"]

# Production route
# routes = [{ pattern = "api.workway.co/*", zone_name = "workway.co" }]

# =============================================================================
# Rate Limiting
# =============================================================================
# Native Cloudflare rate limiting to protect the API from abuse.
# See docs/API_RATE_LIMITS.md for full documentation.

# Note: Cloudflare Rate Limiting is configured via the dashboard or API.
# These comments document the intended configuration:
#
# Rule 1: Global API limit
#   - Match: /workflows/*
#   - Action: Block
#   - Threshold: 1000 requests per minute
#
# Rule 2: Auth endpoint protection (brute force)
#   - Match: /auth/*
#   - Action: Block
#   - Threshold: 20 requests per minute
#
# Rule 3: Per-API-key limit (requires Enterprise)
#   - Match: All authenticated requests
#   - Action: Block
#   - Threshold: Based on tier (free: 100/min, pro: 1000/min, enterprise: 10000/min)

# =============================================================================
# KV Namespaces
# =============================================================================

[[kv_namespaces]]
binding = "API_KEYS"
id = "126746b45e274282a71fba77013be8d3"

[[kv_namespaces]]
binding = "IDEMPOTENCY"
id = "651ca58110834aa1892bd9f5a95596e9"

[[kv_namespaces]]
binding = "WORKFLOW_STORAGE"
id = "7e1d2080a29f420782e73432d72a284f"

# Rate limit tracking KV (for per-API-key limits)
[[kv_namespaces]]
binding = "RATE_LIMITS"
id = "placeholder-create-with-wrangler-kv-create"

# =============================================================================
# Analytics Engine
# =============================================================================
# Custom metrics for tenant attribution, latency tracking, and business KPIs.
# Query via Cloudflare dashboard or GraphQL API.

[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "workway_metrics"

# =============================================================================
# Tail Worker (Distributed Tracing)
# =============================================================================
# Send trace events to the tail worker for log aggregation and analysis.
# Events are sent AFTER the response, so they don't impact latency.

[[tail_consumers]]
service = "workway-tail-worker"

# =============================================================================
# Workers AI
# =============================================================================

[ai]
binding = "AI"

# =============================================================================
# Environment Variables
# =============================================================================

[vars]
# Rate limit defaults (can be overridden per API key in KV)
RATE_LIMIT_DEFAULT = "1000"
RATE_LIMIT_WINDOW_SECONDS = "60"

# Environment variables (set via wrangler secret for production)
# ENVIRONMENT = "production"

# Development overrides
# [env.dev]
# name = "workway-api-gateway-dev"
